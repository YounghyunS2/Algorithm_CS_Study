# DB

# 조인(Join)

조인이란 두 개 이상의 테이블을 묶어서 하나의 결과물로 만드는 것을 의미합니다. MySQL에서는 JOIN 쿼리로, MongoDB에서는 lookup이라는 쿼리로 처리가 가능합니다. 

조인의 종류에는 대표적으로 내부 조인, 왼쪽 조인, 오른쪽 조인, 합집합 조인이 있습니다.

왼쪽 테이블을 A, 오른쪽 테이블을 B라고 할 시

내부조인(Inner join) : 왼쪽 테이블과 오른쪽 테이블의 두 행이 모두 일치하는 부분만 표기(A ∩ B)

왼쪽조인(Left outer join) : 왼쪽 테이블의 모든 행을 표기( (A ∩ B) ∪ (A - B)  = A)

오른쪽조인(Right outer join) : 오른쪽 테이블의 모든 행을 표기 ( (A ∩ B) ∪ (B - A)  = B)

합집합조인(Full outer join) : 조인 조건을 만족하지 않는 행까지 모두 표기((A ∪ B)) 

### 내부조인

두 테이블 간의 교집합을 의미

```sql
SELECT * FROM TableA A
INNER JOIN TableB B ON
A.key = B.key
```

### 왼쪽조인

테이블 A를 기준으로 테이블 B의 일치하는 부분의 레코드와 함께 완전한 레코드 집합을 생성

```sql
SELECT * FROM TableA A
LEFT JOIN TableB B ON
A.key = B.key
```

### 오른쪽조인

테이블 B를 기준으로 테이블 A의 일치하는 부분의 레코드와 함께 완전한 레코드 집합을 생성

```sql
SELECT * FROM TableA A
RIGHT JOIN TableB B ON
A.key = B.key
```

### 합집합조인

양쪽 테이블에서 일치하는 레코드와 함께 테이블 A와 테이블 B의 모든 레코드 집합을 생성

```sql
SELECT * FROM TableA A
FULL OUTER JOIN TableB B ON
A.key = B.key
```

# 조인의 원리

## 중첩 루프 조인

중첩 루프 조인(Nested Loop Join)은 중첩 for 문을 활용하여 조건에 맞는 조인을 하는 방법이며, 랜덤 접근에 대한 비용이 많이 증가하므로 대용량의 테이블에는 적합하지 않습니다

반복문 외부에 있는 테이블을 선행 테이블 또는 외부 테이블(Outer Table)이라 하고, 내부에 있는 테이블을 후행 테이블 또는 내부 테이블(Inner Table)이라 합니다

### 수행과정

1. 선행테이블에서 주어진 조건을 만족하는 행을 찾음
2. 선행 테이블의 조인 키 값을 가지고 후행 테이블에서 조인 수행
3. 선행 테이블의 조건을 만족하는 모든 행에 대해 1번 작업 반복 수행

중첩 루프 조인 기법은 조인이 성공하면 바로 그 결과를 사용자에게 보여줄 수 있기 때문에 결과를 가능한 한 빨리 화면에 띄워야 하는 온라인 프로그램에 적당한 기법이다.

## 정렬 병합 조인

정렬 병합 조인(Sort Merge Join)은 각각의 테이블을 조인할 필드 기준으로 정렬하고 난 후에 조인 작업을 수행하는 방법입니다. 조인할 때 쓸만한 적절한 인덱스가 없고 대용량의 테이블들을 조인하고 조인 조건으로 범위 비교 연산자가 있을 때 씁니다.

정렬 병합 조인은 정렬할 데이터가 많아 메모리에서 모든 정렬 작업을 수행하기 어려운 경우에는 성능이 떨어질 우려가 있습니다. 일반적으로 해시 조인이 성능적으로 유리하나, 비동등 조인에 대해서도 조인 작업이 가능하다는 상대적인 장점이 있기 때문에 쓰입니다. 

### 수행과정

1. 선행 테이블에서 주어진 조건에 맞는 행을 찾음
2. 선행 테이블의 조인 키를 기준으로 정렬 작업 수행
3. 1~2번 작업을 조건에 맞는 모든 행에 대해 반복 수행
4. 후행 테이블에서 주어진 조건에 맞는 행을 찾음
5. 후행 테이블의 조인 키를 기준으로 정렬 작업 수행
6. 4~5번 작업을 조건에 맞는 모든 행에 대해 반복 수행
7. 정렬된 결과를 이용하여 조인을 수행하며 조인에 성공하면 추출버퍼에 입력

## 해시 조인

해시 테이블을 기반으로 조인하는 방법입니다. 두 개의 테이블을 조인할 때 하나의 테이블이 메모리에 온전히 들어간다면 중첩 루프 조인보다 효율적입니다. 또한 동등 조인에서만 사용할 수 있습니다.

### 수행과정

1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음
2. 선행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해쉬 테이블 생성
    
    → 조인 컬럼과 SELECT 절에서 필요로 하는 컬럼도 함께 저장
    
3. 1~2번 작업을 조건에 맞는 모든 행에 대해 반복 수행
4. 후행 테이블에서 주어진 조건에 맞는 행을 찾음
5. 후행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해당 버킷을 찾음
    
    → 조인 키를 이용해서 실제 조인될 데이터를 찾음
    
6. 조인에 성공하면 추출 버퍼에 넣음
7. 4~6번 작업을 조건에 맞는 모든 행에 대해 반복 수행
